name: üîê GCP Security Audit

on:
  schedule:
    # Tous les jours √† 8h UTC
    - cron: '0 8 * * *'
  workflow_dispatch: # Permet d√©clenchement manuel
  push:
    branches:
      - main
    paths:
      - 'scripts/**'

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

jobs:
  security-audit:
    name: Audit S√©curit√© GCP
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write # Pour cr√©er issues si probl√®mes critiques

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true

      - name: ‚úÖ V√©rifier authentification
        run: |
          gcloud auth list
          gcloud config list

      - name: üîç Ex√©cuter audit complet
        id: audit
        run: |
          chmod +x scripts/*.sh
          ./scripts/run-full-audit.sh \
            --output-dir ./audit-results \
            --critical-only
        continue-on-error: true

      - name: üìä Analyser r√©sultats
        id: analyze
        run: |
          if [ -f audit-results/audit-*/AUDIT-REPORT.md ]; then
            CRITICAL_COUNT=$(grep -c "CRITIQUES" audit-results/audit-*/AUDIT-REPORT.md || echo 0)
            echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
            echo "::notice::Probl√®mes critiques trouv√©s: $CRITICAL_COUNT"
          fi

      - name: üì§ Upload r√©sultats
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gcp-audit-results-${{ github.run_number }}
          path: audit-results/
          retention-days: 30

      - name: üö® Cr√©er issue si probl√®mes critiques
        if: steps.analyze.outputs.critical_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'audit-results/audit-*/AUDIT-REPORT.md';
            const report = fs.readFileSync(reportPath, 'utf8');

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® GCP Security: ${process.env.CRITICAL_COUNT} probl√®mes critiques d√©tect√©s`,
              body: report,
              labels: ['security', 'critical', 'gcp']
            });

      - name: üí¨ Notification Slack (optionnel)
        if: env.SLACK_WEBHOOK != ''
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          CRITICAL=${{ steps.analyze.outputs.critical_count }}
          STATUS_EMOJI="‚úÖ"
          [ $CRITICAL -gt 0 ] && STATUS_EMOJI="üö®"

          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-Type: application/json' \
            -d "{\"text\":\"$STATUS_EMOJI *GCP Security Audit*\n\nProbl√®mes critiques: *$CRITICAL*\nRun: ${{ github.run_number }}\"}"

      - name: ‚ùå Fail si probl√®mes critiques
        if: steps.analyze.outputs.critical_count > 0
        run: |
          echo "::error::${{ steps.analyze.outputs.critical_count }} probl√®mes de s√©curit√© CRITIQUES d√©tect√©s!"
          exit 1
